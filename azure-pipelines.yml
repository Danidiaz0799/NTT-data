trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: Build
    jobs:
      - job: Backend
        displayName: 'Backend (.NET)'
        steps:
          - task: UseDotNet@2
            inputs:
              version: '9.x'
          - task: DotNetCoreCLI@2
            displayName: 'Restore'
            inputs:
              command: 'restore'
              projects: 'backend/**/*.csproj'
          - task: DotNetCoreCLI@2
            displayName: 'Build'
            inputs:
              command: 'build'
              projects: 'backend/**/*.csproj'
              arguments: '--configuration Release'
          - task: DotNetCoreCLI@2
            displayName: 'Test'
            inputs:
              command: 'test'
              projects: 'backend/Tests/**/*.csproj'
          - task: DotNetCoreCLI@2
            displayName: 'Publish'
            inputs:
              command: 'publish'
              publishWebProjects: false
              projects: 'backend/backend.csproj'
              arguments: '--output $(Build.ArtifactStagingDirectory)'
          - publish: $(Build.ArtifactStagingDirectory)
            artifact: backend

      - job: Frontend
        displayName: 'Frontend (Angular)'
        steps:
          - task: NodeTool@0
            inputs:
              versionSpec: '20.x'
          - script: cd frontend && npm ci && npm run build
            displayName: 'Build Frontend'
          - publish: frontend/dist
            artifact: frontend

  - stage: Deploy
    dependsOn: Build
    jobs:
      - deployment: DeployBackend
        displayName: 'Deploy Backend'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureWebApp@1
                  inputs:
                    azureSubscription: 'Azure-Connection'
                    appName: 'ntt-cliente-api'
                    package: '$(Pipeline.Workspace)/backend'
      
      - deployment: DeployFrontend
        displayName: 'Deploy Frontend'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: AzureStaticWebApp@0
                  inputs:
                    app_location: '$(Pipeline.Workspace)/frontend'
                    azure_static_web_apps_api_token: '$(AZURE_TOKEN)'

